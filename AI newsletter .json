{"files":[{"id":"cccb3141-28a3-488c-8a4c-d563df1b880b","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"Europe/Rome\",\n  \"dependencies\": {\n  },\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\"\n}"},{"id":"78f9f3a0-b36e-4dc4-a86c-8127af2e980e","name":"Codice","type":"server_js","source":"/**\n * MAIN ENTRY POINT\n * This runs once per day (we\u0027ll set a trigger for it).\n * Steps:\n *  1. Get newsletter emails from last day (label: Medium Newsletter)\n *  2. Summarize them with OpenAI\n *  3. Send a digest email to the client\n */\nfunction dailyDigest() {\n  var DAYS_BACK \u003d 1;\n\n  var messages \u003d fetchNewsletters(DAYS_BACK);\n  if (messages.length \u003d\u003d\u003d 0) {\n    Logger.log(\"No newsletters found in the last day.\");\n    return;\n  }\n\n  var sourceText \u003d buildSourceText(messages);\n  var summary \u003d summarizeWithOpenAI(sourceText);  // {text, html}\n\n  sendDigestEmail(summary);\n}\n\n/**\n * Fetch emails with label \"Medium Newsletter\" from the last day.\n * Returns an array of objects:\n * { subject, from, date, body, url }\n */\nfunction fetchNewsletters(daysBack) {\n  var since \u003d new Date();\n  since.setDate(since.getDate() - daysBack);\n\n  var labelName \u003d \"Medium Newsletter\";\n  var label \u003d GmailApp.getUserLabelByName(labelName);\n  if (label \u003d\u003d null) {\n    Logger.log(\u0027Label \"\u0027 + labelName + \u0027\" not found.\u0027);\n    return [];\n  }\n\n  var threads \u003d label.getThreads();\n  var messages \u003d [];\n\n  for (var i \u003d 0; i \u003c threads.length; i++) {\n    var thread \u003d threads[i];\n    var threadMessages \u003d thread.getMessages();\n    var lastIndex \u003d threadMessages.length - 1;\n    var lastMessage \u003d threadMessages[lastIndex];\n\n    var date \u003d lastMessage.getDate();\n    if (date \u003c since) {\n      continue;  // too old, skip\n    }\n\n    var subject \u003d lastMessage.getSubject();\n    var from \u003d lastMessage.getFrom();\n    var bodyHtml \u003d lastMessage.getBody();\n    var bodyText \u003d stripHtml(bodyHtml);\n    var url \u003d thread.getPermalink();\n\n    messages.push({\n      subject: subject,\n      from: from,\n      date: date,\n      body: bodyText,\n      url: url\n    });\n  }\n\n  return messages;\n}\n\n/**\n * Build one big text block from all messages.\n * This is what we send to OpenAI to summarize.\n */\nfunction buildSourceText(messages) {\n  var maxCharsPerMessage \u003d 2500;  // to avoid huge prompts\n  var parts \u003d [];\n\n  for (var i \u003d 0; i \u003c messages.length; i++) {\n    var m \u003d messages[i];\n    var body \u003d m.body;\n    if (body.length \u003e maxCharsPerMessage) {\n      body \u003d body.substring(0, maxCharsPerMessage);\n    }\n\n    var block \u003d\n      \"### Newsletter \" + (i + 1) + \"\\n\" +\n      \"Subject: \" + m.subject + \"\\n\" +\n      \"From: \" + m.from + \"\\n\" +\n      \"Date: \" + m.date.toISOString() + \"\\n\\n\" +\n      body + \"\\n\\n\" +\n      \"Link: \" + m.url + \"\\n\" +\n      \"---\\n\";\n\n    parts.push(block);\n  }\n\n  return parts.join(\"\\n\");\n}\n\n/**\n * Call OpenAI to summarize the newsletters.\n * Returns an object:\n * { text: \"...\", html: \"...\" }\n */\nfunction summarizeWithOpenAI(sourceText) {\n  var scriptProps \u003d PropertiesService.getScriptProperties();\n  var apiKey \u003d scriptProps.getProperty(\"OPENAI_API_KEY\");\n\n  if (!apiKey) {\n    throw new Error(\"OPENAI_API_KEY not set in Script Properties.\");\n  }\n\n  var prompt \u003d\n    \"You are an AI passionate and you want to get frequent updates on new tools and their implementations.\" +\n    \" Summarize the daily content of the newsletters:\\n\\n\" +\n    \"1) Today main topics (max 3 bullets, 20 words per bullet)\\n\" +\n    \"2) ‚ÄúTry this‚Äù (3 concrete ideas you can try today)\\n\" +\n    \"3) 3 short talking points for a client meeting\\n\" +\n    \"4) Links list (source ‚Üí 1 line why it matters)\\n\\n\" +\n    \"Keep it friendly, plain English, no jargon. Total under 350 words.\\n\\n\" +\n    \"CONTENT START\\n\" +\n    sourceText +\n    \"\\nCONTENT END\";\n\n  var url \u003d \"https://api.openai.com/v1/chat/completions\";\n\n  var payload \u003d {\n    model: \"gpt-4o-mini\",\n    messages: [\n      { role: \"system\", content: \"You summarize AI newsletters for creatives.\" },\n      { role: \"user\", content: prompt }\n    ],\n    temperature: 0.4\n  };\n\n  var options \u003d {\n    method: \"post\",\n    contentType: \"application/json\",\n    headers: {\n      Authorization: \"Bearer \" + apiKey\n    },\n    payload: JSON.stringify(payload),\n    muteHttpExceptions: true\n  };\n\n  var response \u003d UrlFetchApp.fetch(url, options);\n\n  // üîπ Explicit HTTP error handling\n  var status \u003d response.getResponseCode();\n  if (status !\u003d\u003d 200) {\n    Logger.log(\"OpenAI API error. Status: \" + status + \" Body: \" + response.getContentText());\n    throw new Error(\"OpenAI API request failed with status \" + status);\n  }\n\n  var data \u003d JSON.parse(response.getContentText());\n\n  if (!data.choices || data.choices.length \u003d\u003d\u003d 0) {\n    throw new Error(\"No choices returned from OpenAI API.\");\n  }\n\n  var text \u003d data.choices[0].message.content;\n  var html \u003d text.replace(/\\n/g, \"\u003cbr\u003e\");\n\n  return {\n    text: text,\n    html: html\n  };\n}\n\n/**\n * Send the digest email to your client.\n * Uses DIGEST_RECIPIENT from Script Properties if set,\n * otherwise sends to your own account.\n */\nfunction sendDigestEmail(summary) {\n  var scriptProps \u003d PropertiesService.getScriptProperties();\n  var recipient \u003d scriptProps.getProperty(\"DIGEST_RECIPIENT\");\n  if (!recipient) {\n    recipient \u003d Session.getActiveUser().getEmail();\n  }\n\n  // üîπ Add current date to subject\n  var today \u003d new Date();\n  var dateStr \u003d today.toISOString().slice(0, 10); // YYYY-MM-DD\n  var subject \u003d \"Your AI Digest ‚Äì \" + dateStr;\n\n  var plainText \u003d summary.text;\n  var htmlBody \u003d\n    \u0027\u003cdiv style\u003d\"font-family: Arial, sans-serif; line-height: 1.5;\"\u003e\u0027 +\n    \"\u003ch2\u003eMedium Newsletter Digest\u003c/h2\u003e\" +\n    \"\u003cp\u003eHere is your daily summary of Medium articles about AI.\u003c/p\u003e\" +\n    \"\u003chr\u003e\" +\n    \"\u003cdiv\u003e\" + summary.html + \"\u003c/div\u003e\" +\n    \"\u003chr\u003e\" +\n    \u0027\u003cp style\u003d\"font-size: 12px; color: #888;\"\u003e\u0027 +\n    \"Generated automatically by your AI Creative Agent (Google Apps Script + OpenAI).\" +\n    \"\u003c/p\u003e\" +\n    \"\u003c/div\u003e\";\n\n  GmailApp.sendEmail(recipient, subject, plainText, { htmlBody: htmlBody });\n}\n\n/**\n * Remove HTML tags and extra whitespace from email bodies.\n */\nfunction stripHtml(html) {\n  if (!html) {\n    return \"\";\n  }\n\n  html \u003d html.replace(/\u003cscript[\\s\\S]*?\u003c\\/script\u003e/gi, \"\");\n  html \u003d html.replace(/\u003cstyle[\\s\\S]*?\u003c\\/style\u003e/gi, \"\");\n  html \u003d html.replace(/\u003c[^\u003e]+\u003e/g, \"\");\n  html \u003d html.replace(/\u0026nbsp;/g, \" \");\n  html \u003d html.replace(/\\s+/g, \" \");\n\n  return html.trim();\n}\n\n\n"}]}